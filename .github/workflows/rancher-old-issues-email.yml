name: "Email old Rancher issues (auth/rbac/projects/audit)"

on:
  schedule:
    - cron: "0 9 * * 1,4"
  workflow_dispatch: {}

permissions:
  contents: write
  actions: read

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure seen list exists
        run: |
          mkdir -p .state
          touch .state/seen-issues.txt

      - name: Query issues and build email body (max 10, no repeats)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          PER_PAGE=100
          MAX_PAGES=20   # up to 2000 attempted per query; search may cap earlier

          # GraphQL search is picky with huge boolean queries, so we split into smaller ones.
          # "Audit logging" query removed per request.
          QUERIES=(
            'repo:rancher/rancher archived:false is:open (auth OR authentication OR login OR oidc OR oauth OR oauth2 OR openid OR saml OR sso OR ldap OR "active directory" OR okta OR keycloak OR dex OR token OR jwt)'
            'repo:rancher/rancher archived:false is:open (rbac OR permission OR permissions OR authorization OR authorize OR "access control" OR "global role" OR globalrole OR rolebinding OR clusterrolebinding OR "role template" OR roletemplate OR crtb OR prtb OR impersonation OR impersonate)'
            'repo:rancher/rancher archived:false is:open (project OR projects OR namespace OR namespaces OR "project member" OR "cluster member" OR "project role" OR "cluster role" OR "move namespace" OR "resource quota" OR limitrange)'
          )

          echo "=== DEBUG: smoke test search (should be >0) ==="
          gh api graphql -f query='
            query($q: String!) {
              search(query: $q, type: ISSUE, first: 1) {
                issueCount
                nodes { ... on Issue { number url } }
              }
            }' -f q='repo:rancher/rancher is:issue is:open project' | jq

          echo '[]' > all.json

          run_search() {
            local q="$1"
            local after_cursor=""
            local page=1

            echo "=== QUERY: $q ==="

            gh api graphql -f query='
              query($q: String!) {
                search(query: $q, type: ISSUE, first: 1) { issueCount }
              }' -f q="$q" | jq -r '"issueCount=" + (.data.search.issueCount|tostring)'

            while [ "$page" -le "$MAX_PAGES" ]; do
              if [ -z "$after_cursor" ]; then
                gh api graphql -f query='
                  query($q: String!, $n: Int!) {
                    search(query: $q, type: ISSUE, first: $n) {
                      pageInfo { hasNextPage endCursor }
                      nodes {
                        ... on Issue {
                          number
                          title
                          url
                          createdAt
                          updatedAt
                          author { login }
                          labels(first: 50) { nodes { name } }
                        }
                      }
                    }
                  }' -f q="$q" -F n="$PER_PAGE" > page.json
              else
                gh api graphql -f query='
                  query($q: String!, $n: Int!, $after: String) {
                    search(query: $q, type: ISSUE, first: $n, after: $after) {
                      pageInfo { hasNextPage endCursor }
                      nodes {
                        ... on Issue {
                          number
                          title
                          url
                          createdAt
                          updatedAt
                          author { login }
                          labels(first: 50) { nodes { name } }
                        }
                      }
                    }
                  }' -f q="$q" -F n="$PER_PAGE" -f after="$after_cursor" > page.json
              fi

              local fetched
              fetched=$(jq '.data.search.nodes | length' page.json)
              local has_next
              has_next=$(jq -r '.data.search.pageInfo.hasNextPage' page.json)
              local end_cursor
              end_cursor=$(jq -r '.data.search.pageInfo.endCursor' page.json)

              echo "page=$page fetched=$fetched hasNext=$has_next"

              jq -s '.[0] + (.[1].data.search.nodes // [])' all.json page.json > all.tmp.json
              mv all.tmp.json all.json

              if [ "$has_next" != "true" ]; then
                break
              fi

              after_cursor="$end_cursor"
              page=$((page + 1))
            done
          }

          for q in "${QUERIES[@]}"; do
            run_search "$q"
          done

          echo "=== DEBUG: total fetched nodes (union pre-dedupe) ==="
          jq 'length' all.json

          jq 'unique_by(.url)' all.json > all.deduped.json

          echo "=== DEBUG: total fetched nodes (after dedupe) ==="
          jq 'length' all.deduped.json

          echo "=== DEBUG: contains issue #40482? (after dedupe) ==="
          jq 'map(select(.number == 40482)) | length' all.deduped.json

          SEEN_JSON=$(awk 'NF {print}' .state/seen-issues.txt | jq -R -s 'split("\n") | map(select(length>0))')
          echo "Seen list count: $(echo "$SEEN_JSON" | jq 'length')"

          jq --argjson seen "$SEEN_JSON" '
            . |
            map(select(([(.labels.nodes // [])[].name] | map(ascii_downcase) | any(startswith("team/")) | not))) |
            map(select(.url as $u | ($seen | index($u)) == null)) |
            sort_by(.createdAt) |
            .[0:10]
          ' all.deduped.json > issues-to-email.json

          COUNT=$(jq 'length' issues-to-email.json)
          echo "New issues to email (max 10): $COUNT"

          echo "Sample candidates (first 10):"
          jq -r '.[] | "\(.createdAt) \(.url) labels=" + ([(.labels.nodes // [])[].name] | join(","))' issues-to-email.json

          echo "EMAIL_SUBJECT=Rancher old open issues (auth/RBAC/projects) - $(date -u +%Y-%m-%d)" >> $GITHUB_ENV

          {
            echo "# rancher/rancher: Old open issues for auth/RBAC/projects (no team/* labels)"
            echo
            echo "Generated: $(date -u +"%Y-%m-%d %H:%M UTC")"
            echo
            if [ "$COUNT" -eq 0 ]; then
              echo "_No new matching issues found._"
            else
              echo "## Oldest first (up to 10, never repeated)"
              echo
              jq -r '
                .[] |
                "- [#\(.number)](\(.url)) \(.title)\n  - created: \(.createdAt)\n  - updated: \(.updatedAt)\n  - author: \(.author.login // "unknown")\n  - labels: " + ([(.labels.nodes // [])[].name] | join(", "))
              ' issues-to-email.json
            fi
          } > email.md

          if [ "$COUNT" -gt 0 ]; then
            jq -r '.[].url' issues-to-email.json >> .state/seen-issues.txt
            sort -u .state/seen-issues.txt -o .state/seen-issues.txt
          fi

      - name: Send email
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ env.EMAIL_SUBJECT }}
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          secure: true
          content_type: text/markdown
          body: file://email.md

      - name: Commit updated seen list (if changed)
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .state/seen-issues.txt
          git commit -m "chore: update seen issues list"
          git push
